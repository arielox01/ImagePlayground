<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing - Face Clustering App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        .progress-container {
            margin-top: 50px;
            max-width: 600px;
        }
        .progress {
            height: 25px;
        }
        #message-box {
            min-height: 80px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container progress-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-cogs mr-2"></i>Face Clustering Progress</h4>
            </div>
            <div class="card-body">
                <h5 id="status-title">Processing...</h5>

                <div class="progress mt-4 mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <div id="message-box" class="mb-3">
                    <p id="status-message">Initializing clustering process...</p>
                </div>

                <div id="time-info" class="text-muted small mb-3">
                    <span id="elapsed-time">Time elapsed: 0s</span>
                </div>

                <div class="text-center mt-4">
                    <a id="back-button" href="{{ url_for('index') }}" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Home
                    </a>
                    <a id="view-results-button" href="{{ url_for('index') }}" class="btn btn-success" style="display: none;">
                        <i class="fas fa-check-circle mr-2"></i>View Results
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            const progressBar = $('#progress-bar');
            const statusMessage = $('#status-message');
            const statusTitle = $('#status-title');
            const elapsedTime = $('#elapsed-time');
            const backButton = $('#back-button');
            const viewResultsButton = $('#view-results-button');

            let startTime = new Date().getTime();

            // Check progress every second
            const progressChecker = setInterval(function() {
                $.getJSON('/get_progress', function(data) {
                    // Update progress bar
                    let progress = data.progress || 0;
                    progressBar.css('width', progress + '%');
                    progressBar.attr('aria-valuenow', progress);

                    // Update message
                    if (data.message) {
                        statusMessage.text(data.message);
                    }

                    // Update time elapsed
                    const now = new Date().getTime();
                    const elapsed = Math.floor((now - startTime) / 1000);
                    let timeString = elapsed + 's';
                    if (elapsed > 60) {
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        timeString = minutes + 'm ' + seconds + 's';
                    }
                    elapsedTime.text('Time elapsed: ' + timeString);

                    // Handle completion or error
                    if (data.status === 'completed') {
                        clearInterval(progressChecker);
                        statusTitle.text('Processing Complete');
                        statusTitle.removeClass('text-warning').addClass('text-success');
                        progressBar.removeClass('progress-bar-animated');
                        backButton.show();
                        viewResultsButton.show();

                        // Add completion time if available
                        if (data.completed_at && data.started_at) {
                            const totalTime = Math.floor(data.completed_at - data.started_at);
                            let timeString = totalTime + 's';
                            if (totalTime > 60) {
                                const minutes = Math.floor(totalTime / 60);
                                const seconds = totalTime % 60;
                                timeString = minutes + 'm ' + seconds + 's';
                            }
                            $('#time-info').append('<br><span>Total processing time: ' + timeString + '</span>');
                        }
                    }
                    else if (data.status === 'error') {
                        clearInterval(progressChecker);
                        statusTitle.text('Error');
                        statusTitle.removeClass('text-warning').addClass('text-danger');
                        progressBar.removeClass('progress-bar-animated').addClass('bg-danger');
                        statusMessage.html('An error occurred:<br>' + data.error);
                        backButton.show();
                    }
                })
                .fail(function() {
                    // Handle connection errors
                    statusMessage.text('Connection error when checking progress. The server might be busy.');
                });
            }, 1000);
        });
    </script>
</body>
</html>